#!/bin/bash
#
# Voice Daemon Control Script
# Part of Whisper Voice Daemon project
#

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'
BOLD='\033[1m'

SERVICE_NAME="voice-daemon"
INSTALL_DIR="$HOME/.local/bin/voice-daemon"
DAEMON_SCRIPT="$INSTALL_DIR/voice-daemon.py"
CONFIG_FILE="$HOME/.config/voice-daemon/config.ini"

# Fallback to current directory if not installed
if [ ! -f "$DAEMON_SCRIPT" ]; then
    DAEMON_SCRIPT="$(dirname "$0")/voice-daemon.py"
fi

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

print_info() {
    echo -e "${BLUE}ℹ${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

get_hotkey() {
    if [ -f "$CONFIG_FILE" ]; then
        grep "^hotkey" "$CONFIG_FILE" | cut -d'=' -f2 | tr -d ' '
    else
        echo "Ctrl+Alt+V"
    fi
}

case "$1" in
    start)
        echo -e "${BOLD}Starting voice daemon...${NC}"
        if systemctl --user start "$SERVICE_NAME" 2>/dev/null; then
            print_success "Voice daemon started"
            local hotkey=$(get_hotkey)
            print_info "Press ${CYAN}$hotkey${NC} to use voice input"
            print_info "Use ${CYAN}voice-ctl status${NC} to check status"
        else
            print_error "Failed to start daemon"
            print_info "Try: ${CYAN}voice-ctl test${NC} for debugging"
            exit 1
        fi
        ;;
    stop)
        echo -e "${BOLD}Stopping voice daemon...${NC}"
        if systemctl --user stop "$SERVICE_NAME" 2>/dev/null; then
            print_success "Voice daemon stopped"
        else
            print_error "Failed to stop daemon"
            exit 1
        fi
        ;;
    restart)
        echo -e "${BOLD}Restarting voice daemon...${NC}"
        if systemctl --user restart "$SERVICE_NAME" 2>/dev/null; then
            print_success "Voice daemon restarted"
            local hotkey=$(get_hotkey)
            print_info "Press ${CYAN}$hotkey${NC} to use voice input"
        else
            print_error "Failed to restart daemon"
            exit 1
        fi
        ;;
    status)
        systemctl --user status "$SERVICE_NAME" --no-pager
        echo ""
        if systemctl --user is-active "$SERVICE_NAME" &>/dev/null; then
            print_success "Daemon is running"
            local hotkey=$(get_hotkey)
            print_info "Hotkey: ${CYAN}$hotkey${NC}"
        else
            print_warning "Daemon is not running"
            print_info "Start with: ${CYAN}voice-ctl start${NC}"
        fi
        ;;
    logs)
        echo -e "${BOLD}Voice daemon logs (Ctrl+C to exit):${NC}"
        echo ""
        journalctl --user -u "$SERVICE_NAME" -f --no-pager
        ;;
    enable)
        if systemctl --user enable "$SERVICE_NAME" 2>/dev/null; then
            print_success "Auto-start enabled"
            print_info "Daemon will start automatically on login"
        else
            print_error "Failed to enable auto-start"
            exit 1
        fi
        ;;
    disable)
        if systemctl --user disable "$SERVICE_NAME" 2>/dev/null; then
            print_success "Auto-start disabled"
            print_info "Daemon will not start automatically"
        else
            print_error "Failed to disable auto-start"
            exit 1
        fi
        ;;
    test)
        echo -e "${BOLD}Testing voice daemon (foreground mode)${NC}"
        echo -e "${CYAN}────────────────────────────────────────${NC}"
        echo ""

        if [ ! -f "$DAEMON_SCRIPT" ]; then
            print_error "Daemon script not found: $DAEMON_SCRIPT"
            print_info "Please run the installer: ./install.sh"
            exit 1
        fi

        local hotkey=$(get_hotkey)
        print_info "Press ${CYAN}$hotkey${NC} to test voice input"
        print_info "Stop recording: Wait 5s, press $hotkey again, or ESC"
        print_info "Exit test: ${CYAN}Ctrl+C${NC}"
        echo ""

        /usr/bin/python3 "$DAEMON_SCRIPT" -m small
        ;;
    config)
        if [ -f "$CONFIG_FILE" ]; then
            echo -e "${BOLD}Current Configuration:${NC}"
            echo ""
            cat "$CONFIG_FILE"
            echo ""
            print_info "Edit: ${CYAN}nano $CONFIG_FILE${NC}"
            print_info "After editing, restart: ${CYAN}voice-ctl restart${NC}"
        else
            print_warning "Config file not found"
            print_info "Expected location: $CONFIG_FILE"
        fi
        ;;
    edit)
        if [ -f "$CONFIG_FILE" ]; then
            ${EDITOR:-nano} "$CONFIG_FILE"
            print_info "Don't forget to restart: ${CYAN}voice-ctl restart${NC}"
        else
            print_error "Config file not found: $CONFIG_FILE"
            exit 1
        fi
        ;;
    version)
        if [ -f "$DAEMON_SCRIPT" ]; then
            local version=$(grep -m 1 "^# Version" "$DAEMON_SCRIPT" | cut -d' ' -f3 || echo "unknown")
            echo "Whisper Voice Daemon v${version:-1.0.1}"
        else
            echo "Whisper Voice Daemon (not installed)"
        fi
        ;;
    help|--help|-h)
        echo -e "${BOLD}${BLUE}Voice Daemon Control${NC}"
        echo ""
        echo -e "${BOLD}USAGE:${NC}"
        echo "  voice-ctl [command]"
        echo ""
        echo -e "${BOLD}COMMANDS:${NC}"
        echo -e "  ${CYAN}start${NC}      - Start the voice daemon"
        echo -e "  ${CYAN}stop${NC}       - Stop the voice daemon"
        echo -e "  ${CYAN}restart${NC}    - Restart the voice daemon"
        echo -e "  ${CYAN}status${NC}     - Show daemon status and configuration"
        echo -e "  ${CYAN}logs${NC}       - Show daemon logs (live, Ctrl+C to exit)"
        echo -e "  ${CYAN}enable${NC}     - Enable auto-start on login"
        echo -e "  ${CYAN}disable${NC}    - Disable auto-start"
        echo -e "  ${CYAN}test${NC}       - Run daemon in foreground (debug mode)"
        echo -e "  ${CYAN}config${NC}     - Show current configuration"
        echo -e "  ${CYAN}edit${NC}       - Edit configuration file"
        echo -e "  ${CYAN}version${NC}    - Show version information"
        echo -e "  ${CYAN}help${NC}       - Show this help message"
        echo ""
        echo -e "${BOLD}EXAMPLES:${NC}"
        echo "  voice-ctl start           # Start daemon"
        echo "  voice-ctl logs            # Watch logs"
        echo "  voice-ctl test            # Test in foreground"
        echo ""
        echo -e "${BOLD}USAGE INSTRUCTIONS:${NC}"
        echo "  1. Start daemon: ${CYAN}voice-ctl start${NC}"
        local hotkey=$(get_hotkey)
        echo "  2. Press hotkey: ${YELLOW}$hotkey${NC}"
        echo "  3. Speak clearly"
        echo "  4. Stop recording:"
        echo "     • Wait 5 seconds (auto-stop)"
        echo "     • Press $hotkey again (manual)"
        echo "     • Press ESC (cancel)"
        echo ""
        echo -e "${BOLD}CONFIGURATION:${NC}"
        echo "  Config file: $CONFIG_FILE"
        echo "  Edit with:   ${CYAN}voice-ctl edit${NC}"
        echo ""
        echo -e "${BOLD}DOCUMENTATION:${NC}"
        echo "  GitHub: https://github.com/alexandrehsantos/whisper-voice-daemon"
        echo ""
        ;;
    *)
        print_error "Unknown command: $1"
        echo ""
        echo "Usage: voice-ctl [command]"
        echo ""
        echo "Common commands:"
        echo "  start, stop, restart, status, logs"
        echo ""
        echo "For full help: ${CYAN}voice-ctl help${NC}"
        exit 1
        ;;
esac
