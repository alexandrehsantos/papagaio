#!/bin/bash
#
# Papagaio Control Script for macOS
# Uses launchd for service management
#
# Author: Alexandre Santos <alexandrehsantos@gmail.com>
# Company: Bulvee Company

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'
BOLD='\033[1m'

SERVICE_LABEL="com.bulvee.papagaio"
PLIST_FILE="$HOME/Library/LaunchAgents/${SERVICE_LABEL}.plist"
CONFIG_FILE="$HOME/.config/papagaio/config.ini"
HOMEBREW_PREFIX="${HOMEBREW_PREFIX:-/usr/local}"

# Fallback paths
if [ -f "$HOMEBREW_PREFIX/opt/papagaio/com.bulvee.papagaio.plist" ]; then
    SOURCE_PLIST="$HOMEBREW_PREFIX/opt/papagaio/com.bulvee.papagaio.plist"
elif [ -f "$(dirname "$0")/com.bulvee.papagaio.plist" ]; then
    SOURCE_PLIST="$(dirname "$0")/com.bulvee.papagaio.plist"
fi

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

print_info() {
    echo -e "${BLUE}ℹ${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

get_hotkey() {
    if [ -f "$CONFIG_FILE" ]; then
        grep "^hotkey" "$CONFIG_FILE" | cut -d'=' -f2 | tr -d ' '
    else
        echo "Cmd+Shift+Alt+V"
    fi
}

is_running() {
    launchctl list 2>/dev/null | grep -q "$SERVICE_LABEL"
}

ensure_plist() {
    if [ ! -f "$PLIST_FILE" ]; then
        if [ -n "$SOURCE_PLIST" ] && [ -f "$SOURCE_PLIST" ]; then
            mkdir -p "$(dirname "$PLIST_FILE")"
            cp "$SOURCE_PLIST" "$PLIST_FILE"
            print_info "Installed launchd service"
        else
            print_error "Service plist not found"
            print_info "Please reinstall Papagaio or create $PLIST_FILE manually"
            return 1
        fi
    fi
    return 0
}

case "$1" in
    start)
        echo -e "${BOLD}Starting voice daemon...${NC}"
        ensure_plist || exit 1

        if is_running; then
            print_warning "Daemon is already running"
        else
            if launchctl load "$PLIST_FILE" 2>/dev/null; then
                sleep 1
                if is_running; then
                    print_success "Voice daemon started"
                    hotkey=$(get_hotkey)
                    print_info "Press ${CYAN}$hotkey${NC} to use voice input"
                else
                    print_error "Daemon failed to start"
                    print_info "Check logs: ${CYAN}papagaio-ctl logs${NC}"
                    exit 1
                fi
            else
                print_error "Failed to start daemon"
                exit 1
            fi
        fi
        ;;
    stop)
        echo -e "${BOLD}Stopping voice daemon...${NC}"
        if is_running; then
            if launchctl unload "$PLIST_FILE" 2>/dev/null; then
                print_success "Voice daemon stopped"
            else
                print_error "Failed to stop daemon"
                exit 1
            fi
        else
            print_warning "Daemon is not running"
        fi
        ;;
    restart)
        echo -e "${BOLD}Restarting voice daemon...${NC}"
        "$0" stop
        sleep 1
        "$0" start
        ;;
    status)
        echo -e "${BOLD}Papagaio Status${NC}"
        echo ""
        if is_running; then
            print_success "Daemon is running"
            hotkey=$(get_hotkey)
            print_info "Hotkey: ${CYAN}$hotkey${NC}"

            # Show PID
            pid=$(launchctl list | grep "$SERVICE_LABEL" | awk '{print $1}')
            if [ -n "$pid" ] && [ "$pid" != "-" ]; then
                print_info "PID: $pid"
            fi
        else
            print_warning "Daemon is not running"
            print_info "Start with: ${CYAN}papagaio-ctl start${NC}"
        fi
        ;;
    logs)
        echo -e "${BOLD}Voice daemon logs:${NC}"
        echo ""
        log_file="$HOMEBREW_PREFIX/var/log/papagaio.log"
        error_file="$HOMEBREW_PREFIX/var/log/papagaio.error.log"

        if [ -f "$log_file" ]; then
            tail -f "$log_file" "$error_file" 2>/dev/null
        else
            print_warning "Log file not found"
            print_info "Expected at: $log_file"
        fi
        ;;
    enable)
        ensure_plist || exit 1
        launchctl load -w "$PLIST_FILE" 2>/dev/null
        print_success "Auto-start enabled"
        print_info "Daemon will start automatically on login"
        ;;
    disable)
        launchctl unload -w "$PLIST_FILE" 2>/dev/null
        print_success "Auto-start disabled"
        print_info "Daemon will not start automatically"
        ;;
    test)
        echo -e "${BOLD}Testing voice daemon (foreground mode)${NC}"
        echo -e "${CYAN}────────────────────────────────────────${NC}"
        echo ""

        hotkey=$(get_hotkey)
        print_info "Press ${CYAN}$hotkey${NC} to test voice input"
        print_info "Stop recording: Wait 5s, press $hotkey again, or ESC"
        print_info "Exit test: ${CYAN}Ctrl+C${NC}"
        echo ""

        papagaio -m small
        ;;
    config)
        if [ -f "$CONFIG_FILE" ]; then
            echo -e "${BOLD}Current Configuration:${NC}"
            echo ""
            cat "$CONFIG_FILE"
            echo ""
            print_info "Edit: ${CYAN}nano $CONFIG_FILE${NC}"
            print_info "After editing, restart: ${CYAN}papagaio-ctl restart${NC}"
        else
            print_warning "Config file not found"
            print_info "Expected location: $CONFIG_FILE"
        fi
        ;;
    edit)
        if [ -f "$CONFIG_FILE" ]; then
            ${EDITOR:-nano} "$CONFIG_FILE"
            print_info "Don't forget to restart: ${CYAN}papagaio-ctl restart${NC}"
        else
            print_error "Config file not found: $CONFIG_FILE"
            exit 1
        fi
        ;;
    settings)
        if command -v papagaio-settings &> /dev/null; then
            papagaio-settings &
            print_success "Settings window opened"
        else
            print_error "Settings GUI not found"
            exit 1
        fi
        ;;
    tray)
        if command -v papagaio-tray &> /dev/null; then
            papagaio-tray &
            print_success "System tray started"
        else
            print_error "Tray app not found"
            exit 1
        fi
        ;;
    version)
        echo "Papagaio v1.1.0"
        echo "macOS (launchd)"
        ;;
    help|--help|-h)
        echo -e "${BOLD}${BLUE}Papagaio Control (macOS)${NC}"
        echo ""
        echo -e "${BOLD}USAGE:${NC}"
        echo "  papagaio-ctl [command]"
        echo ""
        echo -e "${BOLD}COMMANDS:${NC}"
        echo -e "  ${CYAN}start${NC}      - Start the voice daemon"
        echo -e "  ${CYAN}stop${NC}       - Stop the voice daemon"
        echo -e "  ${CYAN}restart${NC}    - Restart the voice daemon"
        echo -e "  ${CYAN}status${NC}     - Show daemon status"
        echo -e "  ${CYAN}logs${NC}       - Show daemon logs (live)"
        echo -e "  ${CYAN}enable${NC}     - Enable auto-start on login"
        echo -e "  ${CYAN}disable${NC}    - Disable auto-start"
        echo -e "  ${CYAN}test${NC}       - Run daemon in foreground (debug)"
        echo -e "  ${CYAN}config${NC}     - Show current configuration"
        echo -e "  ${CYAN}edit${NC}       - Edit configuration file"
        echo -e "  ${CYAN}settings${NC}   - Open graphical settings"
        echo -e "  ${CYAN}tray${NC}       - Start system tray icon"
        echo -e "  ${CYAN}version${NC}    - Show version information"
        echo -e "  ${CYAN}help${NC}       - Show this help message"
        echo ""
        echo -e "${BOLD}USAGE INSTRUCTIONS:${NC}"
        echo "  1. Start daemon: ${CYAN}papagaio-ctl start${NC}"
        hotkey=$(get_hotkey)
        echo "  2. Press hotkey: ${YELLOW}$hotkey${NC}"
        echo "  3. Speak clearly"
        echo "  4. Stop recording:"
        echo "     • Wait 5 seconds (auto-stop)"
        echo "     • Press $hotkey again (manual)"
        echo "     • Press ESC (cancel)"
        echo ""
        echo -e "${BOLD}PERMISSIONS:${NC}"
        echo "  Grant Accessibility permissions for keyboard simulation:"
        echo "  System Preferences > Security & Privacy > Privacy > Accessibility"
        echo ""
        echo -e "${BOLD}DOCUMENTATION:${NC}"
        echo "  GitHub: https://github.com/alexandrehsantos/papagaio"
        echo ""
        ;;
    *)
        print_error "Unknown command: $1"
        echo ""
        echo "Usage: papagaio-ctl [command]"
        echo ""
        echo "Common commands:"
        echo "  start, stop, restart, status, logs"
        echo ""
        echo "For full help: ${CYAN}papagaio-ctl help${NC}"
        exit 1
        ;;
esac
