#!/bin/bash
#
# papagaio-ctl - Control script for the Papagaio voice daemon
#

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'
BOLD='\033[1m'

SERVICE_NAME="papagaio"
CONFIG_FILE="$HOME/.config/papagaio/config.ini"

# Resolve the papagaio binary dynamically:
#   1. /usr/bin/papagaio        (deb install)
#   2. next to this script      (AppImage or dev)
#   3. anywhere in PATH
resolve_daemon() {
    if [ -x "/usr/bin/papagaio" ]; then
        echo "/usr/bin/papagaio"
    elif [ -x "$(dirname "$(readlink -f "$0")")/papagaio" ]; then
        echo "$(dirname "$(readlink -f "$0")")/papagaio"
    elif command -v papagaio &>/dev/null; then
        command -v papagaio
    else
        echo ""
    fi
}

DAEMON_BIN="$(resolve_daemon)"

print_success() { echo -e "${GREEN}✓${NC} $1"; }
print_error()   { echo -e "${RED}✗${NC} $1"; }
print_info()    { echo -e "${BLUE}ℹ${NC} $1"; }
print_warning() { echo -e "${YELLOW}⚠${NC} $1"; }

get_hotkey() {
    if [ -f "$CONFIG_FILE" ]; then
        grep "^hotkey" "$CONFIG_FILE" | cut -d'=' -f2 | tr -d ' '
    else
        echo "Ctrl+Alt+V"
    fi
}

require_daemon() {
    if [ -z "$DAEMON_BIN" ]; then
        print_error "Papagaio binary not found"
        print_info "Searched: /usr/bin/papagaio, script directory, PATH"
        print_info "Install with: sudo dpkg -i papagaio_*.deb"
        exit 1
    fi
}

case "$1" in
    start)
        echo -e "${BOLD}Starting voice daemon...${NC}"
        if systemctl --user start "$SERVICE_NAME" 2>/dev/null; then
            print_success "Voice daemon started"
            hotkey=$(get_hotkey)
            print_info "Press ${CYAN}$hotkey${NC} to use voice input"
            print_info "Use ${CYAN}papagaio-ctl status${NC} to check status"
        else
            print_error "Failed to start daemon"
            print_info "Try: ${CYAN}papagaio-ctl test${NC} for debugging"
            exit 1
        fi
        ;;
    stop)
        echo -e "${BOLD}Stopping voice daemon...${NC}"
        if systemctl --user stop "$SERVICE_NAME" 2>/dev/null; then
            print_success "Voice daemon stopped"
        else
            print_error "Failed to stop daemon"
            exit 1
        fi
        ;;
    restart)
        echo -e "${BOLD}Restarting voice daemon...${NC}"
        if systemctl --user restart "$SERVICE_NAME" 2>/dev/null; then
            print_success "Voice daemon restarted"
            hotkey=$(get_hotkey)
            print_info "Press ${CYAN}$hotkey${NC} to use voice input"
        else
            print_error "Failed to restart daemon"
            exit 1
        fi
        ;;
    status)
        systemctl --user status "$SERVICE_NAME" --no-pager
        echo ""
        if systemctl --user is-active "$SERVICE_NAME" &>/dev/null; then
            print_success "Daemon is running"
            hotkey=$(get_hotkey)
            print_info "Hotkey: ${CYAN}$hotkey${NC}"
        else
            print_warning "Daemon is not running"
            print_info "Start with: ${CYAN}papagaio-ctl start${NC}"
        fi
        ;;
    logs)
        echo -e "${BOLD}Voice daemon logs (Ctrl+C to exit):${NC}"
        echo ""
        journalctl --user -u "$SERVICE_NAME" -f --no-pager
        ;;
    enable)
        if systemctl --user enable "$SERVICE_NAME" 2>/dev/null; then
            print_success "Auto-start enabled"
            print_info "Daemon will start automatically on login"
        else
            print_error "Failed to enable auto-start"
            exit 1
        fi
        ;;
    disable)
        if systemctl --user disable "$SERVICE_NAME" 2>/dev/null; then
            print_success "Auto-start disabled"
            print_info "Daemon will not start automatically"
        else
            print_error "Failed to disable auto-start"
            exit 1
        fi
        ;;
    test)
        echo -e "${BOLD}Testing voice daemon (foreground mode)${NC}"
        echo -e "${CYAN}────────────────────────────────────────${NC}"
        echo ""

        require_daemon

        hotkey=$(get_hotkey)
        print_info "Binary: ${CYAN}$DAEMON_BIN${NC}"
        print_info "Press ${CYAN}$hotkey${NC} to test voice input"
        print_info "Stop recording: Wait 5s, press $hotkey again, or ESC"
        print_info "Exit test: ${CYAN}Ctrl+C${NC}"
        echo ""

        "$DAEMON_BIN" -m small
        ;;
    config)
        if [ -f "$CONFIG_FILE" ]; then
            echo -e "${BOLD}Current Configuration:${NC}"
            echo ""
            cat "$CONFIG_FILE"
            echo ""
            print_info "Edit: ${CYAN}nano $CONFIG_FILE${NC}"
            print_info "After editing, restart: ${CYAN}papagaio-ctl restart${NC}"
        else
            print_warning "Config file not found"
            print_info "Expected location: $CONFIG_FILE"
        fi
        ;;
    edit)
        if [ -f "$CONFIG_FILE" ]; then
            ${EDITOR:-nano} "$CONFIG_FILE"
            print_info "Don't forget to restart: ${CYAN}papagaio-ctl restart${NC}"
        else
            print_error "Config file not found: $CONFIG_FILE"
            exit 1
        fi
        ;;
    version|-V|--version)
        require_daemon
        "$DAEMON_BIN" --version
        ;;
    help|--help|-h)
        echo -e "${BOLD}${BLUE}Papagaio Control${NC}"
        echo ""
        echo -e "${BOLD}USAGE:${NC}"
        echo "  papagaio-ctl <command>"
        echo ""
        echo -e "${BOLD}COMMANDS:${NC}"
        echo -e "  ${CYAN}start${NC}      Start the voice daemon"
        echo -e "  ${CYAN}stop${NC}       Stop the voice daemon"
        echo -e "  ${CYAN}restart${NC}    Restart the voice daemon"
        echo -e "  ${CYAN}status${NC}     Show daemon status"
        echo -e "  ${CYAN}logs${NC}       Follow daemon logs (Ctrl+C to exit)"
        echo -e "  ${CYAN}enable${NC}     Enable auto-start on login"
        echo -e "  ${CYAN}disable${NC}    Disable auto-start"
        echo -e "  ${CYAN}test${NC}       Run daemon in foreground (debug)"
        echo -e "  ${CYAN}config${NC}     Show current configuration"
        echo -e "  ${CYAN}edit${NC}       Edit configuration file"
        echo -e "  ${CYAN}version${NC}    Show version"
        echo -e "  ${CYAN}help${NC}       Show this help"
        echo ""
        echo -e "${BOLD}QUICK START:${NC}"
        echo "  papagaio-ctl start"
        hotkey=$(get_hotkey)
        echo -e "  Press ${YELLOW}$hotkey${NC} and speak"
        echo "  Recording stops after 5s of silence, or press hotkey again"
        echo ""
        echo -e "${BOLD}CONFIG:${NC}  $CONFIG_FILE"
        echo -e "${BOLD}DOCS:${NC}    man papagaio | man papagaio-ctl"
        echo -e "${BOLD}SOURCE:${NC}  https://github.com/alexandrehsantos/papagaio"
        echo ""
        ;;
    *)
        print_error "Unknown command: $1"
        echo ""
        echo "Usage: papagaio-ctl <command>"
        echo "Commands: start, stop, restart, status, logs, test, help"
        echo ""
        echo "Run ${CYAN}papagaio-ctl help${NC} for full usage."
        exit 1
        ;;
esac
